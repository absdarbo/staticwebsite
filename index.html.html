<!DOCTYPE html>
<html>

<head>
  <title>Crawley Map with Sales Reps</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map {
      height: 500px;
    }

    .popup-content {
      width: 300px;
    }

    .key {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 10px;
      border-radius: 5px;
    }

    .key-item {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }

    .key-color {
      width: 20px;
      height: 20px;
      margin-right: 5px;
      border-radius: 50%;
    }

    .add-button {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
    }

    .marker-popup {
      position: relative;
    }

    .edit-button {
      position: absolute;
      top: 5px;
      right: 5px;
      padding: 3px 6px;
      font-size: 12px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <button class="add-button" id="add-button">Add</button>
  <input type="file" id="load-data" accept=".json">
  <div id="map"></div>
  <div class="key">
    <div class="key-item">
      <input type="checkbox" id="filter-graeham" value="blue" checked>
      <div class="key-color" style="background-color: blue;"></div> Graeham Morrison
    </div>
    <div class="key-item">
      <input type="checkbox" id="filter-jamie" value="red" checked>
      <div class="key-color" style="background-color: red;"></div> Jamie Helyer
    </div>
    <div class="key-item">
      <input type="checkbox" id="filter-kieran" value="green" checked>
      <div class="key-color" style="background-color: green;"></div> Kieran Clark
    </div>
    <div class="key-item">
      <input type="checkbox" id="filter-tony" value="yellow" checked>
      <div class="key-color" style="background-color: yellow;"></div> Tony Macklin
    </div>
    <div class="key-item">
      <input type="checkbox" id="filter-abdoulaye" value="purple" checked>
      <div class="key-color" style="background-color: purple;"></div> Abdoulaye Darbo
    </div>
    <div class="key-item">
      <input type="checkbox" id="filter-other" value="orange" checked>
      <div class="key-color" style="background-color: orange;"></div> Other
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const crawley = [51.11, -0.18];
    const map = L.map('map').setView(crawley, 10);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
    }).addTo(map);

    L.circle(crawley, {
      color: 'blue',
      fillColor: 'blue',
      fillOpacity: 0.1,
      radius: 20 * 1609.34
    }).addTo(map);

    const addButton = document.getElementById('add-button');
    const loadDataInput = document.getElementById('load-data');

    let markersData = []; // Array to store marker data

    // Load markers from file (if available) when the map is initialized
    function loadMarkers() {
      fetch('markers.json')
        .then(response => response.json())
        .then(data => {
          markersData = data; // Update markersData with loaded data
          data.forEach(markerData => {
            createMarker(markerData);
          });
          applyFilter(); // Apply filter after loading markers
        })
        .catch(error => {
          console.error('Error loading markers:', error);
        });
    }

    loadMarkers(); // Load markers on page load

    addButton.addEventListener('click', () => {
      const searchPopup = L.popup()
        .setLatLng(map.getCenter())
        .setContent('<input type="text" id="search-input" placeholder="Enter address"><button id="search-button">Search</button>')
        .openOn(map);

      const popupContent = searchPopup.getElement();

      popupContent.querySelector('#search-button').addEventListener('click', () => {
        const query = popupContent.querySelector('#search-input').value;
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`)
          .then(response => response.json())
          .then(data => {
            if (data.length > 0) {
              const lat = parseFloat(data[0].lat);
              const lon = parseFloat(data[0].lon);
              map.setView([lat, lon], 15);
              showAddMarkerPopup(lat, lon, data[0]);
            } else {
              alert('Location not found.');
            }
          })
          .catch(error => {
            console.error('Error fetching location:', error);
            alert('An error occurred while searching for the location.');
          });
      });
    });

    function showAddMarkerPopup(lat, lon, searchResult, existingMarker = null) {
      const existingData = existingMarker ? existingMarker.getPopup().getContent().querySelector('.popup-content') : null;
      const companyName = existingData ? existingData.querySelector('h3').textContent : '';
      const companyPurchase = existingData ? existingData.querySelector('p:nth-of-type(1)').textContent.replace('Purchase: ', '') : '';
      const companySize = existingData ? existingData.querySelector('p:nth-of-type(2)').textContent.replace('Size: ', '') : '';

      let selectedRepColorAdd = 'blue'; // Set default color

      if (existingMarker && existingMarker._icon) {
        selectedRepColorAdd = window.getComputedStyle(existingMarker._icon.querySelector('div')).backgroundColor;
        if (selectedRepColorAdd.startsWith('rgb')) {
          selectedRepColorAdd = rgbToHex(selectedRepColorAdd);
        }
      }

      const addMarkerPopup = L.popup()
        .setLatLng([lat, lon])
        .setContent(`<div>Company Name: <input type="text" id="company-name" value="${companyName}"><br>Purchase: <input type="text" id="company-purchase" value="${companyPurchase}"><br>Company Size: <input type="text" id="company-size" value="${companySize}"><br>Sales Rep: <select id="rep-dropdown-add"><option value="blue">Graeham Morrison</option><option value="red">Jamie Helyer</option><option value="green">Kieran Clark</option><option value="yellow">Tony Macklin</option><option value="purple">Abdoulaye Darbo</option><option value="orange">Other</option></select><br><button id="save-marker">Save</button></div>`)
        .openOn(map);

      const popupContent = addMarkerPopup.getElement();

      popupContent.querySelector('#rep-dropdown-add').value = selectedRepColorAdd;

      popupContent.querySelector('#save-marker').addEventListener('click', () => {
        const newCompanyName = popupContent.querySelector('#company-name').value;
        const newCompanyPurchase = popupContent.querySelector('#company-purchase').value;
        const newCompanySize = popupContent.querySelector('#company-size').value;
        const newSelectedRepColorAdd = popupContent.querySelector('#rep-dropdown-add').value;

        if (existingMarker) {
          // ... (update existing marker and markersData) ...
          downloadMarkersData();
        } else {
          const marker = L.marker([lat, lon], {
            icon: L.divIcon({
              className: `${newSelectedRepColorAdd}-marker`,
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              html: `<div style="background-color: ${newSelectedRepColorAdd}; height: 100%; width: 100%; border-radius: 50% 50% 50% 0;"></div>`
            }),
            draggable: true
          }).addTo(map);

          // Create the popup content with the edit button
          const popupContent = document.createElement('div');
          popupContent.classList.add('marker-popup');
          popupContent.innerHTML = `<div class="popup-content"><h3>${newCompanyName}</h3><p>Purchase: ${newCompanyPurchase}</p><p>Size: ${newCompanySize}</p><p>Address: ${searchResult.display_name}</p></div><button class="edit-button">Edit</button>`;

          // Add event listener for the "Edit" button
          const editButton = popupContent.querySelector('.edit-button');
          editButton.addEventListener('click', () => {
            marker.closePopup();
            showAddMarkerPopup(marker.getLatLng().lat, marker.getLatLng().lng, searchResult, marker);
          });

          // Bind the popup content to the marker
          marker.bindPopup(popupContent);

          marker.on('mouseover', function() {
            this.openPopup();
          });

          // Add mouseleave event to the popup content
          popupContent.addEventListener('mouseleave', () => {
            marker.closePopup();
          });

          addMarkerPopup.remove();

          // Add marker data to markersData array
          markersData.push({
            lat: lat,
            lng: lon,
            companyName: newCompanyName,
            companyPurchase: newCompanyPurchase,
            companySize: newCompanySize,
            color: newSelectedRepColorAdd,
            address: searchResult.display_name
          });

          // Apply filter after the popup is closed
          marker.on("popupclose", applyFilter);

          // Download JSON file
          downloadMarkersData();
        }
      });
    }

    // ... (Helper function rgbToHex) ...

    // ... (Filter functionality) ...

    function downloadMarkersData() {
      const jsonString = JSON.stringify(markersData);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'markers.json';
      link.click();
    }

    // Function to load markers from JSON file
    function loadMarkersFromFile(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = JSON.parse(e.target.result);
        markersData = data; // Update markersData with the loaded data
        data.forEach(markerData => {
          createMarker(markerData);
        });
        applyFilter(); // Apply filter after loading markers
      };
      reader.readAsText(file);
    }

    function createMarker(markerData) {
      const marker = L.marker([markerData.lat, markerData.lng], {
        icon: L.divIcon({
          className: `${markerData.color}-marker`,
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          html: `<div style="background-color: ${markerData.color}; height: 100%; width: 100%; border-radius: 50% 50% 50% 0;"></div>`
        }),
        draggable: true
      }).addTo(map)
        .bindPopup(`<div class="marker-popup"><div class="popup-content"><h3>${markerData.companyName}</h3><p>Purchase: ${markerData.companyPurchase}</p><p>Size: ${markerData.companySize}</p><p>Address: ${markerData.address}</p></div><button class="edit-button">Edit</button></div>`);

      marker.on('mouseover', function() {
        this.openPopup();
      });

      marker.on('popupopen', function() {
        const popupContent = this.getPopup().getElement();
        const editButton = popupContent.querySelector('.edit-button');
        editButton.addEventListener('click', () => {
          this.closePopup();
          showAddMarkerPopup(this.getLatLng().lat, this.getLatLng().lng, markerData, this); // Pass markerData instead of searchResult
        });

        popupContent.addEventListener('mouseleave', () => {
          this.closePopup();
        });
      });

      marker.on("popupclose", applyFilter);
    }

    // Event listener for file input
    loadDataInput.addEventListener('change', (event) => {
      const file = event.target.files[0];
      loadMarkersFromFile(file);
    });
  </script>
</body>
</html>