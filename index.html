<!DOCTYPE html>
<html>

<head>
  <title>Crawley Map with Sales Reps</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <button class="add-button" id="add-button">Add</button>
  <input type="file" id="load-data" accept=".json">
  <div id="map"></div>
  <div class="key">
    <div class="key-item">
      <input type="checkbox" id="filter-graeham" value="blue" checked>
      <div class="key-color" style="background-color: blue;"></div> Graeham Morrison
    </div>
    <div class="key-item">
      <input type="checkbox" id="filter-jamie" value="red" checked>
      <div class="key-color" style="background-color: red;"></div> Jamie Helyer
    </div>
    <div class="key-item">
      <input type="checkbox" id="filter-kieran" value="green" checked>
      <div class="key-color" style="background-color: green;"></div> Kieran Clark
    </div>
    <div class="key-item">
      <input type="checkbox" id="filter-tony" value="yellow" checked>
      <div class="key-color" style="background-color: yellow;"></div> Tony Macklin
    </div>
    <div class="key-item">
      <input type="checkbox" id="filter-abdoulaye" value="purple" checked>
      <div class="key-color" style="background-color: purple;"></div> Abdoulaye Darbo
    </div>
    <div class="key-item">
      <input type="checkbox" id="filter-other" value="orange" checked>
      <div class="key-color" style="background-color: orange;"></div> Other
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const crawley = [51.11, -0.18];
    const map = L.map('map').setView(crawley, 10);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
    }).addTo(map);

    L.circle(crawley, {
      color: 'blue',
      fillColor: 'blue',
      fillOpacity: 0.1,
      radius: 20 * 1609.34
    }).addTo(map);

    const addButton = document.getElementById('add-button');
    const loadDataInput = document.getElementById('load-data');

    let markersData =;

    function loadMarkers() {
      fetch('markers.json')
      .then(response => response.json())
      .then(data => {
          markersData = data;
          data.forEach(markerData => {
            createMarker(markerData);
          });
          applyFilter();
        })
      .catch(error => {
          console.error('Error loading markers:', error);
        });
    }

    loadMarkers();

    addButton.addEventListener('click', () => {
      const searchPopup = L.popup()
      .setLatLng(map.getCenter())
      .setContent('<input type="text" id="search-input" placeholder="Enter address"><button id="search-button">Search</button>')
      .openOn(map);

      const popupContent = searchPopup.getElement();

      popupContent.querySelector('#search-button').addEventListener('click', () => {
        const query = popupContent.querySelector('#search-input').value;
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`)
        .then(response => response.json())
        .then(data => {
            if (data.length > 0) {
              const lat = parseFloat(data.lat);
              const lon = parseFloat(data.lon);
              map.setView([lat, lon], 15);
              showAddMarkerPopup(lat, lon, data);
            } else {
              alert('Location not found.');
            }
          })
        .catch(error => {
            console.error('Error fetching location:', error);
            alert('An error occurred while searching for the location.');
          });
      });
    });

    function showAddMarkerPopup(lat, lon, searchResult, existingMarker = null) {
      //... (get existing data if editing)...

      const addMarkerPopup = L.popup()
      .setLatLng([lat, lon])
      .setContent(`<div>Company Name: <input type="text" id="company-name" value="${companyName}"><br>Purchase: <input type="text" id="company-purchase" value="${companyPurchase}"><br>Company Size: <input type="text" id="company-size" value="${companySize}"><br>Sales Rep: <select id="rep-dropdown-add"><option value="blue">Graeham Morrison</option><option value="red">Jamie Helyer</option><option value="green">Kieran Clark</option><option value="yellow">Tony Macklin</option><option value="purple">Abdoulaye Darbo</option><option value="orange">Other</option></select><br><button id="save-marker">Save</button></div>`)
      .openOn(map);

      //... (set selected sales rep in dropdown)...

      const popupContent = addMarkerPopup.getElement();

      popupContent.querySelector('#save-marker').addEventListener('click', () => {
        //... (get updated company details)...

        if (existingMarker) {
          //... (update existing marker and markersData)...
          downloadMarkersData();
        } else {
          const marker = L.marker([lat, lon], {
            //... (marker options)...
          }).addTo(map);

          //... (create popup content with edit button)...

          marker.on('mouseover', function() {
            this.openPopup();
          });

          marker.on('popupopen', function() {
            //... (edit button logic)...
          });

          addMarkerPopup.remove();

          //... (add marker data to markersData array)...

          // Apply filter after the popup is closed
          marker.on("popupclose", applyFilter);

          // Download JSON file
          downloadMarkersData();
        }
      });
    }

    //... (Helper function rgbToHex)...

    //... (Filter functionality)...

    function downloadMarkersData() {
      //... (downloadMarkersData function remains the same)...
    }

    // Function to load markers from JSON file
    function loadMarkersFromFile(file) {
      //... (loadMarkersFromFile function remains the same)...
    }

    //... (createMarker function remains the same)...

    // Event listener for file input
    loadDataInput.addEventListener('change', (event) => {
      const file = event.target.files;
      loadMarkersFromFile(file);
    });
  </script>
</body>
</html>
